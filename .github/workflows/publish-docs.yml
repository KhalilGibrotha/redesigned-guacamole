---
name: ðŸ“š Publish Documentation to Confluence

on:
  workflow_call:
    inputs:
      target_environment:
        description: 'Target environment for publishing'
        required: false
        type: string
        default: 'production'
      dry_run:
        description: 'Perform a dry run without actual publishing'
        required: false
        type: boolean
        default: false
    secrets:
      CONFLUENCE_URL:
        required: false
      CONFLUENCE_USER:
        required: false
      CONFLUENCE_API_TOKEN:
        required: false

  # Add manual trigger for testing
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target environment for publishing'
        required: false
        type: choice
        options:
          - production
          - staging
          - development
        default: 'production'
      dry_run:
        description: 'Perform a dry run without actual publishing'
        required: false
        type: boolean
        default: true

jobs:
  publish-confluence:
    name: ðŸš€ Publish to Confluence
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: read

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Install required packages for Confluence publishing
            pip install jinja2 pyyaml requests markdown beautifulsoup4
          fi

      - name: ðŸ” Validate Configuration
        run: |
          echo "ðŸ” Validating Confluence configuration..."
          
          # Check if we're in dry-run mode
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ðŸ§ª Running in DRY RUN mode - secrets validation relaxed"
            
            # Check if secrets are available (but don't fail if missing)
            if [[ -n "${{ secrets.CONFLUENCE_URL }}" ]]; then
              echo "âœ… CONFLUENCE_URL is configured"
            else
              echo "âš ï¸ CONFLUENCE_URL is not configured (OK for dry run)"
            fi
            
            if [[ -n "${{ secrets.CONFLUENCE_USER }}" ]]; then
              echo "âœ… CONFLUENCE_USER is configured"
            else
              echo "âš ï¸ CONFLUENCE_USER is not configured (OK for dry run)"
            fi
            
            if [[ -n "${{ secrets.CONFLUENCE_API_TOKEN }}" ]]; then
              echo "âœ… CONFLUENCE_API_TOKEN is configured"
            else
              echo "âš ï¸ CONFLUENCE_API_TOKEN is not configured (OK for dry run)"
            fi
            
            echo "ðŸ§ª Dry run mode: proceeding with available configuration"
          else
            echo "ðŸš€ Running in LIVE mode - all secrets required"
            
            # Check if required secrets are provided for live run
            if [[ -z "${{ secrets.CONFLUENCE_URL }}" ]]; then
              echo "âŒ CONFLUENCE_URL secret is required for live publishing"
              exit 1
            fi
            
            if [[ -z "${{ secrets.CONFLUENCE_USER }}" ]]; then
              echo "âŒ CONFLUENCE_USER secret is required for live publishing"
              exit 1
            fi
            
            if [[ -z "${{ secrets.CONFLUENCE_API_TOKEN }}" ]]; then
              echo "âŒ CONFLUENCE_API_TOKEN secret is required for live publishing"
              exit 1
            fi
            
            echo "âœ… All required secrets are configured for live publishing"
          fi

      - name: ðŸ”§ Prepare Publishing Environment
        run: |
          echo "ðŸ”§ Preparing publishing environment..."
          
          # Create output directory
          mkdir -p output/confluence
          
          # Set environment variables (with defaults for missing secrets)
          echo "CONFLUENCE_URL=${{ secrets.CONFLUENCE_URL || 'https://your-confluence.atlassian.net' }}" >> $GITHUB_ENV
          echo "CONFLUENCE_USER=${{ secrets.CONFLUENCE_USER || 'not-configured' }}" >> $GITHUB_ENV
          echo "CONFLUENCE_TOKEN=${{ secrets.CONFLUENCE_API_TOKEN || 'not-configured' }}" >> $GITHUB_ENV
          echo "DRY_RUN=${{ inputs.dry_run }}" >> $GITHUB_ENV
          echo "TARGET_ENV=${{ inputs.target_environment }}" >> $GITHUB_ENV
          
          echo "âœ… Environment prepared for ${{ inputs.dry_run == true && 'DRY RUN' || 'LIVE' }} mode"

      - name: ðŸ“ Process AAP Documentation
        run: |
          echo "ðŸ“ Processing AAP documentation templates..."
          
          # Make the script executable
          chmod +x scripts/confluence_publisher.py
          
          # Run the Python-based Confluence publisher
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ðŸ§ª Running in DRY RUN mode"
            python3 scripts/confluence_publisher.py \
              --dry-run \
              --docs-dir docs \
              --vars-file vars/aap.yml
          else
            echo "ðŸš€ Running in LIVE mode"
            python3 scripts/confluence_publisher.py \
              --docs-dir docs \
              --vars-file vars/aap.yml \
              --confluence-url "${{ secrets.CONFLUENCE_URL || 'https://your-confluence.atlassian.net' }}" \
              --confluence-user "${{ secrets.CONFLUENCE_USER || 'not-configured' }}" \
              --confluence-token "${{ secrets.CONFLUENCE_API_TOKEN || 'not-configured' }}"
          fi

      - name: ðŸ“Š Generate Publishing Report
        if: always()
        run: |
          echo "ðŸ“Š Generating publishing report..."
          
          # Create a summary report
          cat > output/confluence/publishing_report.md << EOF
          # ðŸ“š Confluence Publishing Report
          
          ## ðŸ“‹ Publishing Details
          - **Target Environment**: ${{ inputs.target_environment }}
          - **Dry Run**: ${{ inputs.dry_run }}
          - **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Git Reference**: ${{ github.ref_name }}
          - **Commit SHA**: ${{ github.sha }}
          - **Workflow Run**: ${{ github.run_number }}
          
          ## ðŸ”— Links
          - **Repository**: ${{ github.server_url }}/${{ github.repository }}
          - **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ## ðŸ“ˆ Status
          ${{ inputs.dry_run == true && 'ðŸ§ª **DRY RUN** - No actual changes were made' || 'âœ… **LIVE RUN** - Documentation was published to Confluence' }}
          EOF
          
          echo "âœ… Publishing report generated"
          cat output/confluence/publishing_report.md

      - name: ðŸ“¤ Upload Publishing Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: confluence-publishing-report-${{ github.run_id }}
          path: |
            output/confluence/
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ”” Publishing Summary
        if: always()
        run: |
          echo "## ðŸ“š Confluence Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Environment**: ${{ inputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Reference**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "### ðŸ§ª Dry Run Results" >> $GITHUB_STEP_SUMMARY
            echo "- No actual changes were made to Confluence" >> $GITHUB_STEP_SUMMARY
            echo "- Documentation processing completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "- Ready for live publishing when needed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Publishing Results" >> $GITHUB_STEP_SUMMARY
            echo "- Documentation has been published to Confluence" >> $GITHUB_STEP_SUMMARY
            echo "- Check Confluence space for updated content" >> $GITHUB_STEP_SUMMARY
          fi
